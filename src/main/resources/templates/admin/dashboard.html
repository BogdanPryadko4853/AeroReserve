<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" th:href="@{/}">
            <i class="fas fa-plane"></i> AeroReserve Admin
        </a>
        <div class="navbar-nav ms-auto">
            <a class="nav-link" th:href="@{/}">
                <i class="fas fa-home"></i> Public Site
            </a>
            <a class="nav-link" th:href="@{/logout}">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1>Admin Dashboard</h1>
            <p class="lead">Welcome to the administration panel</p>

            <!-- Backup Management Section -->
            <div class="card mt-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-database"></i> Database Backup Management
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="d-grid gap-2">
                                <button class="btn btn-success" onclick="createBackup()">
                                    <i class="fas fa-plus-circle"></i> Create Backup
                                </button>
                                <small class="text-muted">Create new database backup</small>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="d-grid gap-2">
                                <button class="btn btn-warning" onclick="listBackups()">
                                    <i class="fas fa-list"></i> List Backups
                                </button>
                                <small class="text-muted">Show available backups</small>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#restoreModal">
                                    <i class="fas fa-undo"></i> Restore Backup
                                </button>
                                <small class="text-muted">Restore from backup</small>
                            </div>
                        </div>
                    </div>

                    <!-- Backup Status -->
                    <div id="backupStatus" class="mt-3" style="display: none;">
                        <div class="alert alert-info">
                            <i class="fas fa-sync fa-spin"></i> <span id="statusMessage">Processing...</span>
                        </div>
                    </div>

                    <!-- Backups List -->
                    <div id="backupsList" class="mt-3" style="display: none;">
                        <h6>Available Backups:</h6>
                        <div class="list-group" id="backupsListContent">
                            <!-- Backups will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Other Management Cards -->
            <div class="row mt-4">
                <div class="col-md-3 mb-3">
                    <div class="card text-white bg-primary">
                        <div class="card-body text-center">
                            <i class="fas fa-users fa-3x mb-3"></i>
                            <h5>Manage Users</h5>
                            <a th:href="@{/admin/users}" class="btn btn-light btn-sm">Go to Users</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card text-white bg-success">
                        <div class="card-body text-center">
                            <i class="fas fa-plane fa-3x mb-3"></i>
                            <h5>Manage Flights</h5>
                            <a th:href="@{/admin/flights}" class="btn btn-light btn-sm">Go to Flights</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card text-white bg-warning">
                        <div class="card-body text-center">
                            <i class="fas fa-ticket-alt fa-3x mb-3"></i>
                            <h5>Manage Bookings</h5>
                            <a th:href="@{/admin/bookings}" class="btn btn-light btn-sm">Go to Bookings</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card text-white bg-secondary">
                        <div class="card-body text-center">
                            <i class="fas fa-cogs fa-3x mb-3"></i>
                            <h5>System Info</h5>
                            <a th:href="@{/admin/system}" class="btn btn-light btn-sm">System Status</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Restore Backup Modal -->
<div class="modal fade" id="restoreModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Restore Database Backup</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Select Backup File:</label>
                    <select class="form-select" id="backupFileSelect">
                        <option value="">Loading backups...</option>
                    </select>
                </div>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Warning:</strong> This will replace the current database with the backup data. This action cannot be undone.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="restoreBackup()">Restore Backup</button>
            </div>
        </div>
    </div>
</div>

<!-- CSRF Token (скрытые поля для Thymeleaf) -->
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>

<script>
    // Получаем CSRF токен из meta тегов
    function getCsrfToken() {
        return document.querySelector('meta[name="_csrf"]').getAttribute('content');
    }

    function getCsrfHeaderName() {
        return document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
    }

    // Create new backup
    function createBackup() {
        showStatus('Creating backup... Please wait.');

        fetch('/api/admin/backup/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [getCsrfHeaderName()]: getCsrfToken()  // Добавляем CSRF токен
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text();
            })
            .then(result => {
                showStatus(result, result.includes('successfully') ? 'success' : 'error');
                setTimeout(listBackups, 2000);
            })
            .catch(error => {
                showStatus('Error: ' + error, 'error');
            });
    }

    // List available backups
    function listBackups() {
        showStatus('Loading backups list...');

        fetch('/api/admin/backup/list')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(backups => {
                const backupsList = document.getElementById('backupsListContent');
                backupsList.innerHTML = '';

                if (backups.length === 0) {
                    backupsList.innerHTML = '<div class="list-group-item text-muted">No backups found</div>';
                } else {
                    backups.forEach(backup => {
                        const backupItem = document.createElement('div');
                        backupItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                        // Экранируем кавычки в имени файла
                        const safeBackupName = backup.replace(/'/g, "\\'");
                        backupItem.innerHTML = `
                        <div>
                            <i class="fas fa-file-archive text-primary"></i>
                            <strong>${backup}</strong>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="restoreBackup('${safeBackupName}')">
                            <i class="fas fa-undo"></i> Restore
                        </button>
                    `;
                        backupsList.appendChild(backupItem);
                    });
                }

                document.getElementById('backupsList').style.display = 'block';
                hideStatus();

                // Also update modal select
                updateRestoreModal(backups);
            })
            .catch(error => {
                showStatus('Error loading backups: ' + error, 'error');
            });
    }

    // Restore from backup
    function restoreBackup(backupFile = null) {
        const backupFileName = backupFile || document.getElementById('backupFileSelect').value;

        if (!backupFileName) {
            alert('Please select a backup file');
            return;
        }

        if (!confirm(`Are you sure you want to restore from backup: ${backupFileName}? This will replace ALL current data!`)) {
            return;
        }

        showStatus(`Restoring from backup: ${backupFileName}...`);

        fetch('/api/admin/backup/restore', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [getCsrfHeaderName()]: getCsrfToken()  // Добавляем CSRF токен
            },
            body: JSON.stringify({ backupFile: backupFileName })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text();
            })
            .then(result => {
                showStatus(result, result.includes('successfully') ? 'success' : 'error');
                // Close modal if open
                const modal = bootstrap.Modal.getInstance(document.getElementById('restoreModal'));
                if (modal) modal.hide();
            })
            .catch(error => {
                showStatus('Error: ' + error, 'error');
            });
    }

    // Update restore modal with backups list
    function updateRestoreModal(backups) {
        const select = document.getElementById('backupFileSelect');
        select.innerHTML = '';

        if (backups.length === 0) {
            select.innerHTML = '<option value="">No backups available</option>';
            return;
        }

        select.innerHTML = '<option value="">Select backup file...</option>';
        backups.forEach(backup => {
            const option = document.createElement('option');
            option.value = backup;
            option.textContent = backup;
            select.appendChild(option);
        });
    }

    // Show status message
    function showStatus(message, type = 'info') {
        const statusDiv = document.getElementById('backupStatus');

        statusDiv.innerHTML = `
            <div class="alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'}">
                <i class="fas ${type === 'error' ? 'fa-exclamation-triangle' : type === 'success' ? 'fa-check-circle' : 'fa-sync fa-spin'}"></i>
                ${message}
            </div>
        `;
        statusDiv.style.display = 'block';
    }

    // Hide status message
    function hideStatus() {
        document.getElementById('backupStatus').style.display = 'none';
    }

    // Load backups when modal is shown
    document.getElementById('restoreModal').addEventListener('show.bs.modal', function () {
        listBackups();
    });

    // Auto-load backups list on page load
    document.addEventListener('DOMContentLoaded', function() {
        listBackups();
    });
</script>
</body>
</html>